<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <title>SmartBizz App ‚Äî POS</title>
  <style>
    :root{--brand:#3d5ed4;--bg:#f6f8ff;--muted:#6b7280;--card:#fff;--receipt-width:58mm;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),#fff);color:#111}
    header{display:flex;align-items:center;gap:12px;padding:14px 20px;background:var(--card);border-bottom:1px solid #eef2ff}
    .logo{width:56px;height:56px;border-radius:999px;background:var(--brand);display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:0 8px 30px rgba(61,94,212,0.12)}
    .app-name{font-weight:800}
    .container{display:grid;grid-template-columns:260px 1fr;gap:18px;padding:18px}
    nav{background:var(--card);padding:12px;border-radius:12px;border:1px solid #eef2ff;height:calc(100vh - 120px);overflow:auto}
    nav button{display:flex;align-items:center;gap:8px;width:100%;padding:10px;border-radius:8px;border:0;background:transparent;text-align:left;cursor:pointer}
    nav button.active{background:linear-gradient(90deg,rgba(61,94,212,0.08),rgba(61,94,212,0.03))}
    main{padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);min-height:70vh;border:1px solid #eef2ff}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(47,79,255,0.04);border:1px solid rgba(61,94,212,0.03);margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #f1f5fb;text-align:left}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    input,select,textarea,button{padding:8px;border-radius:8px;border:1px solid #e6edf9;background:#fff;flex:1}
    .hidden{display:none}
    .center{display:flex;align-items:center;justify-content:center}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .muted{color:var(--muted)}
    @media(max-width:900px){.container{grid-template-columns:1fr}}
    @media print {
      body, html {margin:0 !important;padding:0 !important;background:#fff !important;}
      body * {visibility:hidden !important;box-shadow:none !important;border-radius:0 !important;}
      #printable-content, #printable-content * {visibility:visible !important;position:static !important;left:0 !important;top:0 !important;width:100% !important;font-family:monospace !important;font-size:12px !important;background:#fff !important;color:#111 !important;box-shadow:none !important;border-radius:0 !important;}
      #printable-content {width:var(--receipt-width,58mm) !important;min-width:0 !important;max-width:100% !important;padding:0 !important;margin:0 !important;}
      @page {margin:0 !important;size:auto;}
    }
    .receipt{width:var(--receipt-width,58mm);padding:12px;font-family:monospace}
    .receipt .logo{width:56px;height:56px;border-radius:50%;font-weight:900;margin:0 auto}
    #auth-screen{position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,0.45);backdrop-filter:blur(2px)}
    #auth-card{width:620px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.3)}
    #receipt-width-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 99;
      background: #fff;
      border: 1px solid #eef2ff;
      border-radius: 8px;
      padding: 6px 12px;
      box-shadow: 0 2px 8px rgba(47,79,255,0.06);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap:8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">SB</div>
    <div>
      <div class="app-name">SmartBizz App</div>
      <div class="small">Smartbizz POS </div>
      <div class="small">created by brian</div>
    </div>
    <div style="margin-left:auto" id="user-area"></div>
  </header>

  <div class="container">
    <nav id="sidebar">
      <button data-page="dashboard" class="active">üè† Dashboard</button>
      <button data-page="pos">üõí POS / Sell</button>
      <button data-page="products">üì¶ Products</button>
      <button data-page="inventory">üìà Inventory</button>
      <button data-page="customers">üë• Customers</button>
      <button data-page="employees">üë®‚Äçüíº Employees</button>
      <button data-page="reports">üìä Reports</button>
      <button data-page="zreport">üßæ Z-Report</button>
      <button data-page="settings">‚öôÔ∏è Settings</button>
      <div style="margin-top:12px"><button id="logoutBtn" class="btn secondary">Logout</button></div>
    </nav>
    <main id="main">
      <div id="dashboard-page" class="page card"></div>
        <div id="pos-page" class="page hidden"></div>
        <div id="products-page" class="page hidden card"></div>
        <div id="inventory-page" class="page hidden card"></div>
        <div id="customers-page" class="page hidden card"></div>
        <div id="employees-page" class="page hidden card"></div>
        <div id="reports-page" class="page hidden card"></div>
        <div id="zreport-page" class="page hidden card"></div>
        <div id="settings-page" class="page hidden card"></div>
    </main>
  </div>
  <div id="receipt-width-selector" class="hidden">
    <label for="receipt-width">Receipt width:</label>
    <select id="receipt-width">
      <option value="58mm">58mm (Small)</option>
      <option value="80mm">80mm (Large)</option>
      <option value="100mm">100mm (Wide)</option>
      <option value="auto">Auto</option>
    </select>
  </div>
  <div id="auth-screen">
    <div id="auth-card"></div>
  </div>
  <div id="printable-content" class="hidden">
    <div class="receipt card" id="receipt-content"></div>
    <div class="receipt card" id="report-content"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- State and login ---
    const STORAGE_KEY = 'smartbizz_complete_v1';
    const defaultState = { nextReceipt:1001, users:[], products:[], customers:[], receipts:[], suppliers:[], settings:{businessName:'SmartBizz',address:'',vat:'',currency:'KES',taxPercent:0} };
    function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState)); return JSON.parse(JSON.stringify(defaultState)); } try{return JSON.parse(raw);}catch(e){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState)); return JSON.parse(JSON.stringify(defaultState)); } }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(State)); }
    let State = loadState(); let currentUser = null;
    function pid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
    function $(id){ return document.getElementById(id); }
    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function formatCurrency(v){ return (State.settings.currency||'KES') + ' ' + Number(v||0).toLocaleString(); }
    async function sha256Hex(text){ const enc = new TextEncoder(); const data = enc.encode(text); const h = await crypto.subtle.digest('SHA-256', data); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    async function showAuth(){ const card = $('auth-card');
      if(State.users.length===0){
        card.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
            <div class='logo'>SB</div>
            <div><div style='font-weight:900;font-size:18px'>Welcome ‚Äî Setup Admin</div><div class='small'>Create your admin account</div></div>
          </div>
          <div style='display:grid;gap:8px'>
            <input id='setup-name' placeholder='Full name' />
            <input id='setup-user' placeholder='Username' />
            <input id='setup-pass' placeholder='Password' type='password' />
            <div style='display:flex;justify-content:flex-end;gap:8px'><button class='btn' id='setup-save'>Create admin</button></div>
          </div>`;
        $('setup-save').onclick = async ()=>{ const name=$('setup-name').value.trim(); const user=$('setup-user').value.trim(); const pass=$('setup-pass').value; if(!name||!user||!pass){ alert('All fields required'); return; } const hash = await sha256Hex(pass); State.users.push({id:pid('u'),username:user,passwordHash:hash,role:'admin',name}); saveState(); showLogin(); };
      } else { showLogin(); }
    }
    function showLogin(){ const card = $('auth-card'); card.innerHTML = `
      <div style='display:flex;gap:12px;align-items:center;margin-bottom:10px'>
        <div class='logo'>SB</div>
        <div><div style='font-weight:900;font-size:18px'>Sign in</div><div class='small'>Enter credentials</div></div>
      </div>
      <div style='display:grid;gap:8px'>
        <input id='login-user' placeholder='Username' />
        <input id='login-pass' placeholder='Password' type='password' />
        <div style='display:flex;justify-content:flex-end;gap:8px'><button class='btn' id='login-btn'>Sign in</button></div>
      </div>`; $('login-btn').onclick = loginHandler; }
    async function loginHandler(){ const u=$('login-user').value.trim(); const p=$('login-pass').value; if(!u||!p){ alert('Enter username and password'); return; } const found = State.users.find(x=>x.username===u); if(!found){ alert('No such user'); return; } const h = await sha256Hex(p); if(h !== found.passwordHash){ alert('Invalid password'); return; } currentUser = found; $('auth-screen').style.display='none'; $('user-area').innerHTML = `<div class='small'>${escapeHtml(currentUser.name||currentUser.username)} ‚Ä¢ ${currentUser.role}</div>`; applyRole(); renderAll(); }
    function applyRole(){ if(!currentUser) return; document.querySelector('button[data-page="employees"]').style.display = currentUser.role === 'admin' ? 'flex' : 'none'; document.querySelector('button[data-page="settings"]').style.display = currentUser.role === 'admin' ? 'flex' : 'none'; }
    window.onload = ()=>{ showAuth(); };

    // --- Tabs and Navigation ---
    function showPage(pg){
      document.querySelectorAll('main .page').forEach(p=>p.classList.add('hidden'));
      document.getElementById(pg+'-page').classList.remove('hidden');
      document.querySelectorAll('nav button[data-page]').forEach(b=>b.classList.remove('active'));
      document.querySelector('nav button[data-page="'+pg+'"]').classList.add('active');
    }
    document.querySelectorAll('nav button[data-page]').forEach(b=>{
      b.onclick = function(){ showPage(this.getAttribute('data-page')); };
    });
    document.getElementById('logoutBtn').onclick = function(){
      currentUser = null;
      $('auth-screen').style.display = '';
      $('user-area').innerHTML = "";
      showAuth();
    };

    // --- Receipt width selector logic ---
    function setReceiptWidth(val) {
      var root = document.documentElement;
      if(val === "auto") root.style.setProperty('--receipt-width', '100%');
      else root.style.setProperty('--receipt-width', val);
      document.querySelectorAll('.receipt').forEach(function(el){
        el.style.width = val === "auto" ? "100%" : val;
      });
      document.getElementById('printable-content').style.width = val === "auto" ? "100%" : val;
    }
    function showReceiptWidthSelector(show) {
      document.getElementById('receipt-width-selector').classList.toggle('hidden', !show);
    }
    document.getElementById('receipt-width').addEventListener('change', function(e){
      setReceiptWidth(e.target.value);
    });
    setReceiptWidth("58mm");

    // --- Print error handling ---
    window.onafterprint = function(){
      document.getElementById('printable-content').classList.add('hidden');
      document.getElementById('receipt-content').innerHTML = '';
      document.getElementById('report-content').innerHTML = '';
      showReceiptWidthSelector(false);
    };
    window.onbeforeprint = function(){
      document.getElementById('printable-content').classList.remove('hidden');
      showReceiptWidthSelector(true);
    };

    // --- Service Worker registration for offline support ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => {
            console.log('Service worker registered!', reg);
          })
          .catch(err => {
            console.error('Service worker registration failed:', err);
          });
      });
    }

    // --- Main app rendering and modal system ---
    function renderAll(){
      renderDashboard();
      renderPOS();
      renderProducts();
      renderInventory();
      renderCustomers();
      renderEmployees();
      renderReports();
      renderZReport();
      renderSettings();
      applyRole();
    }

    // Centralized modal system
    function showModal(title, contentHtml, onSave, onCancel){
      const wrap = document.createElement('div');
      wrap.className = 'modal-wrapper';
      wrap.style.position='fixed'; wrap.style.inset='0'; wrap.style.display='grid'; wrap.style.placeItems='center'; wrap.style.background='rgba(2,6,23,0.4)';
      wrap.innerHTML = `<div style='background:#fff;padding:16px;border-radius:12px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto'><h3 style='margin-top:0'>${title}</h3><div id="modal-content">${contentHtml}</div></div>`;
      document.body.appendChild(wrap);
      if(onCancel) wrap.querySelector('#modal-cancel').onclick = ()=>wrap.remove();
      if(onSave) wrap.querySelector('#modal-save').onclick = ()=>onSave(wrap);
      return wrap;
    }
    function closeModal(){
        const modal = document.querySelector('.modal-wrapper');
        if(modal) modal.remove();
    }

    // --- Dashboard ---
    function renderDashboard(){
      const el = $('dashboard-page');
      const salesToday = State.receipts.filter(r=> isSameDay(new Date(r.date), new Date())).reduce((s,r)=>s+r.total,0);
      const productsCount = State.products.length;
      const customersCount = State.customers.length;
      const employeesCount = State.users.length;
      const lowStock = State.products.filter(p=>p.stock<=5).length;
      el.innerHTML = `<h3>Dashboard</h3>
        <div class="grid cols-3">
          <div class='card'>Today's Sales<br/><strong>${formatCurrency(salesToday)}</strong></div>
          <div class='card'>Products<br/><strong>${productsCount}</strong></div>
          <div class='card'>Low stock<br/><strong style='color:${lowStock?"red":"inherit"}'>${lowStock}</strong></div>
          <div class='card'>Customers<br/><strong>${customersCount}</strong></div>
          <div class='card'>Employees<br/><strong>${employeesCount}</strong></div>
        </div>
        <div class="card">
          <h4>Recent Sales</h4>
          <div>${State.receipts.slice(-8).reverse().map(r=>`<div style='display:flex;justify-content:space-between;padding:6px 0'><div><strong>#${r.number}</strong><div class='small'>${r.items.length} items ‚Ä¢ ${new Date(r.date).toLocaleString()}</div></div><div>${formatCurrency(r.total)}</div></div>`).join('')}</div>
        </div>`;
    }
    function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

    // --- POS ---
    let Cart = [];
    function renderPOS(){
      const el = $('pos-page');
      el.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 380px;gap:12px;max-width:100%">
          <div class="card">
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
              <input id="pos-search" placeholder="Search product by name or SKU" />
              <select id="pos-category"><option value="all">All categories</option></select>
              <button class="btn" id="pos-add-product">+ Product</button>
            </div>
            <div id="catalog" style="min-height:160px;overflow:auto"></div>
          </div>
          <div class="card">
            <h4>Cart</h4>
            <div id="cart-list" style="min-height:80px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="cart-customer"><option value="">Walk-in Customer</option></select>
              <button class="btn secondary" id="add-new-customer-btn">+ New</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="cart-payment"><option>Cash</option><option>M-Pesa</option><option>Card</option></select>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
              <label class="small">Discount</label>
              <input id="cart-discount" type="number" min="0" value="0" style="width:70px" title="Discount in currency" />
              <label class="small">%</label>
              <input id="cart-discount-pct" type="number" min="0" max="100" value="0" style="width:55px" title="Discount in percent" />
            </div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
              <div class="small">Total:</div>
              <div style="font-size:20px;font-weight:800" id="cart-total">KES 0</div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn" id="cart-checkout">Checkout</button>
              <button class="btn secondary" id="cart-clear">Clear</button>
              <button class="btn secondary" id="cart-drawer">üóÑÔ∏è Open Drawer</button>
            </div>
          </div>
        </div>
      `;
      renderPOSCustomers();
      renderCategories();
      renderCatalog('');
      document.getElementById('pos-search').oninput = function(){ renderCatalog(this.value); };
      document.getElementById('pos-category').onchange = function(){ renderCatalog(document.getElementById('pos-search').value); };
      document.getElementById('pos-add-product').onclick = ()=>openProductModal();
      document.getElementById('cart-discount').oninput = renderCart;
      document.getElementById('cart-discount-pct').oninput = renderCart;
      document.getElementById('cart-checkout').onclick = startCheckout;
      document.getElementById('cart-clear').onclick = clearCart;
      document.getElementById('cart-drawer').onclick = openCashDrawer;
      document.getElementById('add-new-customer-btn').onclick = ()=>openCustomerModal();
      renderCart();
    }
    function renderPOSCustomers(){
      const sel = document.getElementById('cart-customer'); if(!sel) return;
      sel.innerHTML = `<option value="">Walk-in Customer</option>` + State.customers.map(c=>`<option value='${c.id}'>${escapeHtml(c.name)}</option>`).join('');
    }
    function renderCategories(){
      const sel = document.getElementById('pos-category');
      if(!sel) return;
      const cats = ['all',...Array.from(new Set(State.products.map(p=>p.category).filter(Boolean)))];
      sel.innerHTML = cats.map(c=>`<option value='${c}'>${c==='all'?'All categories':c}</option>`).join('');
    }
    function renderCatalog(q=''){
      const el = document.getElementById('catalog');
      if(!el) return;
      const cat = document.getElementById('pos-category').value;
      const list = State.products.filter(p=> (p.name.toLowerCase().includes(q.toLowerCase()) || (p.sku||'').toLowerCase().includes(q.toLowerCase())) && (cat==='all' || p.category===cat));
      if(list.length===0){ el.innerHTML = '<div class="small" style="padding:12px">No matching products</div>'; return; }
      el.innerHTML = list.map(p=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5fb"><div><strong>${escapeHtml(p.name)}</strong><div class='small'>${p.sku||''} ‚Ä¢ ${p.category||''} ‚Ä¢ Stock: ${p.stock}</div></div><div style='text-align:right'><div style='font-weight:800'>${formatCurrency(p.price)}</div><div style='margin-top:6px'><button class='btn' onclick='addToCart("${p.id}")' ${p.stock<=0? 'disabled':''}>Add</button></div></div></div>`).join('');
    }
    window.addToCart = function(id){
      const p = State.products.find(x=>x.id===id);
      if(!p) return;
      if(p.stock<=0){ alert('Out of stock'); return; }
      const ex = Cart.find(c=>c.id===id);
      if(ex){ if(ex.qty+1 > p.stock){ alert('Not enough stock'); return; } ex.qty++; } else Cart.push({id:p.id,name:p.name,price:p.price,qty:1});
      renderCart();
    }
    function renderCart(){
      var el = document.getElementById('cart-list'); if(!el) return;
      el.innerHTML = Cart.map(it=>
        `<div style='display:flex;justify-content:space-between;align-items:center;padding:6px 0'>
          <div><strong>${escapeHtml(it.name)}</strong><div class='small'>x${it.qty}</div></div>
          <div><div>${formatCurrency(it.price*it.qty)}</div>
            <div style='margin-top:6px;display:flex;gap:6px'>
              <button class='btn secondary' onclick='changeQty("${it.id}",-1)'>-</button>
              <button class='btn secondary' onclick='changeQty("${it.id}",1)'>+</button>
            </div>
          </div>
        </div>`
      ).join('');
      var subtotal = Cart.reduce((s,i)=>s+i.price*i.qty,0);
      var discount = getCartDiscount();
      var tax = Math.round((subtotal - discount) * (State.settings.taxPercent||0)/100);
      var total = subtotal - discount + tax;
      document.getElementById('cart-total').innerText = formatCurrency(total);
    }
    window.changeQty = function(id,delta){
      const it = Cart.find(x=>x.id===id); if(!it) return; const p = State.products.find(x=>x.id===id);
      it.qty += delta; if(it.qty<=0) Cart = Cart.filter(x=>x.id!==id); if(it.qty>p.stock) it.qty=p.stock; renderCart();
    }
    function clearCart(){ if(!confirm('Clear cart?')) return; Cart=[]; renderCart(); }
    function getCartDiscount(){
      var discount = Number(document.getElementById('cart-discount').value||0);
      var discountPct = Number(document.getElementById('cart-discount-pct').value||0);
      var subtotal = Cart.reduce((s,i)=>s+i.price*i.qty,0);
      return discount + ((subtotal*discountPct)/100);
    }
    function startCheckout(){
      if(Cart.length===0){ alert('Cart empty'); return; }
      const subtotal = Cart.reduce((s,i)=>s+i.price*i.qty,0); const discount = getCartDiscount();
      const tax = Math.round((subtotal - discount) * (State.settings.taxPercent||0)/100); const total = subtotal - discount + tax;
      const customerId = document.getElementById('cart-customer').value || null;
      const customer = State.customers.find(c=>c.id === customerId);
      const payment = document.getElementById('cart-payment').value || 'Cash';
      showModal(`Checkout`, `
        <div>Subtotal: ${formatCurrency(subtotal)}</div>
        <div>Discount: ${formatCurrency(discount)}</div>
        <div>Tax: ${formatCurrency(tax)}</div>
        <div style='font-weight:800'>Total: ${formatCurrency(total)}</div>
        <div style='display:flex;gap:8px;margin-top:8px'><button class='btn' id='modal-save'>Confirm Payment</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
      `, ()=>{
        if(payment==='M-Pesa'){
          simulateMpesa(total).then(()=>{
            completeSale(payment, customerId, discount);
            closeModal();
          });
        } else {
          completeSale(payment, customerId, discount);
          closeModal();
        }
      }, null);
    }
    function simulateMpesa(total){
      return new Promise(resolve=>{
        showModal(`Lipa na M-Pesa`, `
          <div class='small'>Enter phone</div>
          <input id='mp-phone' placeholder='2547XXXXXXXX' />
          <div style='display:flex;justify-content:flex-end;gap:8px;margin-top:8px'><button class='btn' id='mp-send'>Send STK</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
          `, (modal)=>{
              const phone = document.getElementById('mp-phone').value.trim();
              if(!phone){ alert('Phone required'); return; }
              const modalContent = document.getElementById('modal-content');
              modalContent.innerHTML = `<h3>Waiting for payment...</h3><div class='small'>Simulated STK push sent to ${escapeHtml(phone)}. Confirming...</div>`;
              setTimeout(()=>{
                modalContent.innerHTML = `<h3>Payment confirmed</h3><div class='small'>M-Pesa payment received</div><div style='display:flex;justify-content:flex-end;margin-top:8px'><button class='btn' id='modal-done'>Done</button></div>`;
                modalContent.querySelector('#modal-done').onclick = ()=>{ modal.remove(); resolve(); }
              }, 1200);
          }, null
        );
      });
    }
    function completeSale(method, customerId, discount){
      const subtotal = Cart.reduce((s,i)=>s+i.price*i.qty,0);
      const tax = Math.round((subtotal - discount) * (State.settings.taxPercent||0)/100);
      const total = subtotal - discount + tax;
      Cart.forEach(it=>{ const p = State.products.find(x=>x.id===it.id); if(p) p.stock -= it.qty; });
      const r = { number: State.nextReceipt++, date:new Date().toISOString(), cashier:currentUser.username, cashierName:currentUser.name||currentUser.username, items:JSON.parse(JSON.stringify(Cart)), subtotal,discount,tax,total,customerId,method };
      State.receipts.push(r);
      saveState();
      renderAll();
      showReceipt(r);
      Cart=[];
      renderCart();
      closeModal();
      alert('Sale recorded');
    }
    async function showReceipt(r){
      const el = $('receipt-content');
      const rep = $('report-content');
      el.innerHTML = '';
      rep.innerHTML = '';
      const customer = r.customerId ? State.customers.find(c=>c.id===r.customerId) : null;
      let html = `<div style='text-align:center;margin-bottom:8px'><div class='logo' style='width:72px;height:72px;border-radius:999px;margin:0 auto;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:900'>SB</div><div style='font-weight:900;font-size:18px;margin-top:8px'>${escapeHtml(State.settings.businessName||'SmartBizz')}</div><div class='small'>${escapeHtml(State.settings.address||'')}</div><div class='small'>VAT: ${escapeHtml(State.settings.vat||'')}</div></div>`;
      html += `<div class='small'>Receipt #: <strong>${r.number}</strong><br/>${new Date(r.date).toLocaleString()}<br/>Cashier: ${escapeHtml(r.cashierName)}<br/>Payment: ${escapeHtml(r.method||'Cash')}${customer?'<br/>Customer: '+escapeHtml(customer.name):''}</div><hr/>`;
      r.items.forEach(i=> html += `<div style='display:flex;justify-content:space-between'><div>${escapeHtml(i.name)} x${i.qty}</div><div>${formatCurrency(i.price*i.qty)}</div></div>`);
      html += `<hr/><div style='display:flex;justify-content:space-between'><div>Subtotal</div><div>${formatCurrency(r.subtotal)}</div></div>`;
      html += `<div style='display:flex;justify-content:space-between'><div>Discount</div><div>${formatCurrency(r.discount||0)}</div></div>`;
      html += `<div style='display:flex;justify-content:space-between'><div>Tax</div><div>${formatCurrency(r.tax)}</div></div>`;
      html += `<div style='display:flex;justify-content:space-between;font-weight:800;font-size:16px'><div>Total</div><div>${formatCurrency(r.total)}</div></div>`;
      html += `<div style='text-align:center;margin-top:8px;font-size:12px' class='small'>${escapeHtml(State.settings.businessName||'SmartBizz')} ‚Ä¢ ${escapeHtml(State.settings.address||'')} ‚Ä¢ VAT: ${escapeHtml(State.settings.vat||'')}</div>`;
      html += `<div style='display:flex;gap:8px;justify-content:center;margin-top:10px'>
          <button class='btn' id='printReceipt'>Print</button>
          <button class='btn secondary' id='downloadPDF'>Download PDF</button>
          ${currentUser && currentUser.role === 'admin' ? `<button class='btn secondary' onclick='openRefundModal(${JSON.stringify(r).replace(/'/g, "\\'")})'>Refund</button>` : ''}
        </div>`;
      el.innerHTML = html;
      $('printable-content').classList.remove('hidden');
      $('receipt-content').style.display = '';
      $('report-content').style.display = 'none';
      showReceiptWidthSelector(true);
      setReceiptWidth(document.getElementById('receipt-width').value || "58mm");
      document.getElementById('printReceipt').onclick = ()=>{ window.print(); };
      document.getElementById('downloadPDF').onclick = ()=>downloadReceiptPDF();
    }
    async function downloadReceiptPDF(){ const container = $('receipt-content'); const canvas = await html2canvas(container, {scale:2}); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({unit:'pt',format:[canvas.width, canvas.height]}); pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height); const fname = `receipt_${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`; pdf.save(fname); }
    function openCashDrawer(){
      var escposCmd = '\x1B\x70\x00\x19\xFF'; // May vary by printer model
      var win = window.open('', '_blank');
      win.document.write(`<pre>${escposCmd}</pre>`);
      win.print();
      win.close();
      alert("Sent open drawer command to printer. Ensure your printer supports ESC/POS!");
    }
    window.openRefundModal = function(receipt){
      const receiptItems = receipt.items.map(i => {
        return `<label><input type="checkbox" checked data-product-id="${i.id}" data-qty="${i.qty}" data-price="${i.price}" data-name="${i.name}" /> ${i.name} (x${i.qty}) - ${formatCurrency(i.price * i.qty)}</label><br/>`;
      }).join('');
      showModal(`Refund Receipt #${receipt.number}`, `
        <p>Select items to refund:</p>
        <div>${receiptItems}</div>
        <div style='margin-top:12px;display:flex;justify-content:flex-end;gap:8px'>
          <button class='btn' id='modal-save'>Process Refund</button>
          <button class='btn secondary' id='modal-cancel'>Cancel</button>
        </div>
      `, (modal)=>{
        const selectedItems = [];
        modal.querySelectorAll('input[type="checkbox"]:checked').forEach(input => {
          selectedItems.push({
            id: input.dataset.productId,
            qty: parseInt(input.dataset.qty),
            price: parseFloat(input.dataset.price),
            name: input.dataset.name
          });
        });
        if(selectedItems.length === 0){ alert('No items selected for refund.'); return; }
        if(confirm('Are you sure you want to process this refund?')){
          selectedItems.forEach(refundItem => {
            const product = State.products.find(p => p.id === refundItem.id);
            if(product) product.stock += refundItem.qty;
          });
          const refundTotal = selectedItems.reduce((sum, si) => sum + (si.price * si.qty), 0);
          State.receipts.push({
            number: `R${State.nextReceipt++}`,
            date: new Date().toISOString(),
            cashier: currentUser.username,
            cashierName: currentUser.name || currentUser.username,
            type: 'refund',
            originalReceipt: receipt.number,
            items: selectedItems,
            total: -refundTotal
          });
          saveState();
          modal.remove();
          renderAll();
          alert('Refund processed successfully.');
        }
      });
    }

    // --- Products ---
    function renderProducts(){
      const el = $('products-page');
      el.innerHTML = `<h3>Products</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button class="btn" id="prod-new">+ New Product</button>
          <button class="btn secondary" id="prod-export">Export CSV</button>
        </div>
        <div id="products-table"></div>`;
      renderProductsTable();
      document.getElementById('prod-new').onclick = ()=>openProductModal();
      document.getElementById('prod-export').onclick = ()=>exportCSV('products');
    }
    function renderProductsTable(){ const el = $('products-table'); if(!el) return; let html = `<table><thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody>`; State.products.forEach(p=>{ html += `<tr><td>${p.sku||''}</td><td>${escapeHtml(p.name)}</td><td>${p.category||''}</td><td>${formatCurrency(p.price)}</td><td style='${p.stock<=5?"color:red;":""}'>${p.stock}</td><td>${currentUser && currentUser.role==='admin' ? `<button class='btn secondary' onclick='openProductModal("${p.id}")'>Edit</button> <button class='btn' onclick='deleteProduct("${p.id}")'>Delete</button>` : ''}</td></tr>`; }); html += `</tbody></table>`; el.innerHTML = html; }
    window.openProductModal = function(id){ const p = State.products.find(x=>x.id===id) || {id:null,sku:'',name:'',price:0,stock:0,category:''}; showModal(`${p.id? 'Edit':'New'} product`, `
      <input id='m-sku' placeholder='SKU' value='${p.sku||''}' /><input id='m-name' placeholder='Name' value='${escapeHtml(p.name||'')}' /><input id='m-cat' placeholder='Category' value='${escapeHtml(p.category||'')}' /><input id='m-price' placeholder='Price' type='number' value='${p.price||0}' /><input id='m-stock' placeholder='Stock' type='number' value='${p.stock||0}' /><div style='display:flex;gap:8px;justify-content:flex-end'><button class='btn' id='modal-save'>Save</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
    `, (modal)=>{
      const sku = modal.querySelector('#m-sku').value.trim(); const name = modal.querySelector('#m-name').value.trim(); const cat = modal.querySelector('#m-cat').value.trim(); const price = Number(modal.querySelector('#m-price').value||0); const stock = Number(modal.querySelector('#m-stock').value||0);
      if(!name){ alert('Name required'); return; }
      if(p.id){ Object.assign(p,{sku,name,category:cat,price,stock}); } else { State.products.push({id:pid('p'),sku,name,category:cat,price,stock}); }
      saveState(); modal.remove(); renderAll();
    });}
    window.deleteProduct = function(id){ if(!confirm('Delete product?')) return; State.products = State.products.filter(x=>x.id!==id); saveState(); renderAll(); }
    
    // --- Inventory ---
    function renderInventory(){
      const el = $('inventory-page');
      el.innerHTML = `<h3>Inventory</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" id="inv-adjust">Adjust Stock</button>
          <button class="btn secondary" id="inv-import">Import CSV</button>
          <button class="btn secondary" id="inv-suppliers">Suppliers</button>
        </div>
        <div id="inventory-table"></div>`;
      renderInventoryTable();
      document.getElementById('inv-adjust').onclick = openAdjustModal;
      document.getElementById('inv-import').onclick = importProductsCSV;
      document.getElementById('inv-suppliers').onclick = renderSuppliers;
    }
    function renderInventoryTable(){ const el = $('inventory-table'); if(!el) return; let html = `<table><thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Actions</th></tr></thead><tbody>`; State.products.forEach(p=> html += `<tr><td>${p.sku||''}</td><td>${escapeHtml(p.name)}</td><td style='${p.stock<=5?"color:red;":""}'>${p.stock}</td><td>${currentUser && currentUser.role==='admin' ? `<button class='btn secondary' onclick='openAdjustModal()'>Adjust</button> <button class='btn' onclick='deleteProduct("${p.id}")'>Delete</button>` : ''}</td></tr>`); html += `</tbody></table>`; el.innerHTML = html; }
    window.openAdjustModal = function(){ showModal(`Stock adjustment`, `
      <select id='m-adj-prod'>${State.products.map(p=>`<option value='${p.id}'>${escapeHtml(p.name)} (stock: ${p.stock})</option>`).join('')}</select>
      <input id='m-adj-qty' placeholder='Qty (use negative to subtract)' type='number' value='0' />
      <div style='display:flex;gap:8px;justify-content:flex-end'><button class='btn' id='modal-save'>Apply</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
    `, (modal)=>{
      const prodId = modal.querySelector('#m-adj-prod').value; const qty = Number(modal.querySelector('#m-adj-qty').value||0);
      if(qty===0) {modal.remove(); return;}
      const p = State.products.find(x=>x.id===prodId);
      if(p) p.stock += qty;
      saveState(); modal.remove(); renderAll();
    }); }
    function renderSuppliers(){
      const el = $('inventory-page');
      el.innerHTML = `<h3>Suppliers</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" id="supp-new">+ New Supplier</button>
        </div>
        <div id="suppliers-table"></div>`;
      const table = $('suppliers-table');
      table.innerHTML = `<table><thead><tr><th>Name</th><th>Contact</th><th>Actions</th></tr></thead><tbody>
      ${State.suppliers.map(s=>`<tr><td>${escapeHtml(s.name)}</td><td>${s.contact||''}</td><td><button class='btn secondary' onclick='openSupplierModal("${s.id}")'>Edit</button> <button class='btn' onclick='deleteSupplier("${s.id}")'>Delete</button></td></tr>`).join('')}
      </tbody></table>`;
      $('supp-new').onclick = ()=>openSupplierModal();
    }
    window.openSupplierModal = function(id){ const s = State.suppliers.find(x=>x.id===id) || {id:null, name:'', contact:''}; showModal(`${s.id?'Edit':'New'} Supplier`, `
      <input id='s-name' placeholder='Name' value='${escapeHtml(s.name||'')}' /><input id='s-contact' placeholder='Contact Info' value='${escapeHtml(s.contact||'')}' /><div style='display:flex;gap:8px;justify-content:flex-end'><button class='btn' id='modal-save'>Save</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
    `, (modal)=>{
      const name = modal.querySelector('#s-name').value.trim(); const contact = modal.querySelector('#s-contact').value.trim();
      if(!name){ alert('Name required'); return; }
      if(s.id){ Object.assign(s,{name,contact}); } else { State.suppliers.push({id:pid('s'),name,contact}); }
      saveState(); modal.remove(); renderSuppliers();
    }); }
    window.deleteSupplier = function(id){ if(!confirm('Delete supplier?')) return; State.suppliers = State.suppliers.filter(x=>x.id!==id); saveState(); renderSuppliers(); }

    // --- Customers ---
    function renderCustomers(){
      const el = $('customers-page');
      el.innerHTML = `<h3>Customers</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button class="btn" id="cust-new">+ New Customer</button>
        </div>
        <div id="customers-table"></div>`;
      renderCustomersTable();
      document.getElementById('cust-new').onclick = ()=>openCustomerModal();
    }
    function renderCustomersTable(){
      const el = $('customers-table'); if(!el) return;
      let html = `<table><thead><tr><th>Name</th><th>Contact</th><th>Actions</th></tr></thead><tbody>`;
      State.customers.forEach(c=>{ html += `<tr><td>${escapeHtml(c.name)}</td><td>${c.contact||''}</td><td><button class='btn secondary' onclick='openCustomerModal("${c.id}")'>Edit</button> <button class='btn' onclick='deleteCustomer("${c.id}")'>Delete</button></td></tr>`; });
      html += `</tbody></table>`; el.innerHTML = html;
    }
    window.openCustomerModal = function(id){
      const c = State.customers.find(x=>x.id===id) || {id:null, name:'', contact:''};
      showModal(`${c.id? 'Edit':'New'} Customer`, `
        <input id='c-name' placeholder='Name' value='${escapeHtml(c.name||'')}' /><input id='c-contact' placeholder='Contact Info' value='${escapeHtml(c.contact||'')}' /><div style='display:flex;gap:8px;justify-content:flex-end'><button class='btn' id='modal-save'>Save</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
      `, (modal)=>{
        const name = modal.querySelector('#c-name').value.trim(); const contact = modal.querySelector('#c-contact').value.trim();
        if(!name){ alert('Name required'); return; }
        if(c.id){ Object.assign(c,{name,contact}); } else { State.customers.push({id:pid('c'),name,contact}); }
        saveState(); modal.remove(); renderAll();
      });
    }
    window.deleteCustomer = function(id){ if(!confirm('Delete customer?')) return; State.customers = State.customers.filter(x=>x.id!==id); saveState(); renderAll(); }
    
    // --- Employees ---
    function renderEmployees(){
      const el = $('employees-page');
      el.innerHTML = `<h3>Employees</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button class="btn" id="emp-new">+ New Employee</button>
        </div>
        <div id="employees-table"></div>`;
      renderEmployeesTable();
      document.getElementById('emp-new').onclick = ()=>openEmployeeModal();
    }
    function renderEmployeesTable(){
      const el = $('employees-table'); if(!el) return;
      let html = `<table><thead><tr><th>Name</th><th>Username</th><th>Role</th><th>Actions</th></tr></thead><tbody>`;
      State.users.forEach(u=>{ html += `<tr><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.username)}</td><td>${escapeHtml(u.role)}</td><td><button class='btn secondary' onclick='openEmployeeModal("${u.id}")'>Edit</button> <button class='btn' onclick='deleteEmployee("${u.id}")'>Delete</button></td></tr>`; });
      html += `</tbody></table>`; el.innerHTML = html;
    }
    window.openEmployeeModal = function(id){
      const u = State.users.find(x=>x.id===id) || {id:null, name:'', username:'', role:'user'};
      showModal(`${u.id?'Edit':'New'} Employee`, `
        <input id='u-name' placeholder='Full Name' value='${escapeHtml(u.name||'')}' /><input id='u-username' placeholder='Username' value='${escapeHtml(u.username||'')}' />
        <input id='u-pass' placeholder='Password (leave blank to not change)' type='password' /><input id='u-pass-confirm' placeholder='Confirm Password' type='password' />
        <select id='u-role'><option value='user'>User</option><option value='admin'>Admin</option></select>
        <div style='display:flex;gap:8px;justify-content:flex-end'><button class='btn' id='modal-save'>Save</button><button class='btn secondary' id='modal-cancel'>Cancel</button></div>
      `, async (modal)=>{
        const name = modal.querySelector('#u-name').value.trim(); const username = modal.querySelector('#u-username').value.trim(); const role = modal.querySelector('#u-role').value; const pass = modal.querySelector('#u-pass').value; const passConfirm = modal.querySelector('#u-pass-confirm').value;
        if(!name||!username){ alert('Name and username required'); return; }
        if(!u.id && (!pass || pass !== passConfirm)){ alert('Passwords must match for new users'); return; }
        if(u.id){ Object.assign(u,{name,username,role}); if(pass) u.passwordHash = await sha256Hex(pass); }
        else { const hash = await sha256Hex(pass); State.users.push({id:pid('u'),username,passwordHash:hash,role,name}); }
        saveState(); modal.remove(); renderAll();
      });
      if(u.role) $('u-role').value = u.role;
    }
    window.deleteEmployee = function(id){ if(State.users.find(u=>u.id===id).role==='admin' && State.users.filter(u=>u.role==='admin').length===1){ alert('Cannot delete the last admin user'); return; } if(!confirm('Delete employee?')) return; State.users = State.users.filter(x=>x.id!==id); saveState(); renderAll(); }
    
    // --- Reports ---
    function renderReports(){
      const el = $('reports-page');
      const totalSales = State.receipts.filter(r=>r.type!=='refund').reduce((s,r)=>s+r.total,0);
      const totalRefunds = State.receipts.filter(r=>r.type==='refund').reduce((s,r)=>s+r.total,0);
      const todaySales = State.receipts.filter(r=> isSameDay(new Date(r.date), new Date()) && r.type!=='refund').reduce((s,r)=>s+r.total,0);
      const topSelling = State.receipts.reduce((agg, r) => { r.items.forEach(item => { if(!agg[item.name]) agg[item.name] = {qty:0, total:0}; agg[item.name].qty += item.qty; agg[item.name].total += item.qty * item.price; }); return agg; }, {});
      const topSellingList = Object.entries(topSelling).sort(([,a],[,b])=>b.total-a.total);
      
      el.innerHTML = `<h3>Reports</h3>
        <div class="grid cols-3">
          <div class='card'>Total Sales<br/><strong>${formatCurrency(totalSales)}</strong></div>
          <div class='card'>Total Refunds<br/><strong style='color:red'>${formatCurrency(totalRefunds)}</strong></div>
          <div class='card'>Today's Sales<br/><strong>${formatCurrency(todaySales)}</strong></div>
        </div>
        <div class="card">
          <h4>Top Selling Products</h4>
          <table><thead><tr><th>Product</th><th>Qty Sold</th><th>Total Revenue</th></tr></thead><tbody>
          ${topSellingList.map(([name, data]) => `<tr><td>${escapeHtml(name)}</td><td>${data.qty}</td><td>${formatCurrency(data.total)}</td></tr>`).join('')}
          </tbody></table>
        </div>
        <div class="card">
          <h4>Sales History</h4>
          <div id="sales-history-table"></div>
        </div>`;
      renderSalesHistoryTable();
    }
    function renderSalesHistoryTable(){
      const el = $('sales-history-table'); if(!el) return;
      let html = `<table><thead><tr><th>Receipt #</th><th>Date</th><th>Cashier</th><th>Customer</th><th>Total</th><th>Actions</th></tr></thead><tbody>`;
      State.receipts.slice().reverse().forEach(r => {
        const customer = r.customerId ? State.customers.find(c=>c.id === r.customerId) : null;
        html += `<tr><td>${r.number}</td><td>${new Date(r.date).toLocaleString()}</td><td>${r.cashierName}</td><td>${customer?escapeHtml(customer.name):'Walk-in'}</td><td style='${r.total<0?"color:red":""}'>${formatCurrency(r.total)}</td><td><button class='btn secondary' onclick='showReceipt(${JSON.stringify(r).replace(/'/g, "\\'")})'>View</button></td></tr>`;
      });
      html += `</tbody></table>`; el.innerHTML = html;
    }

    // --- Z-Report ---
    function renderZReport(){
      const el = $('zreport-page');
      el.innerHTML = `<h3>Z-Report</h3><p>Daily sales summary report. This should be run at the end of the day.</p><button class="btn" onclick="generateZReport()">Generate Today's Z-Report</button><div id="z-report-content" style="margin-top:12px"></div>`;
    }
    function generateZReport(){
      const today = new Date();
      const salesToday = State.receipts.filter(r => isSameDay(new Date(r.date), today));
      const totalSales = salesToday.filter(r=>r.type!=='refund').reduce((sum, r) => sum + r.total, 0);
      const totalRefunds = salesToday.filter(r=>r.type==='refund').reduce((sum, r) => sum + r.total, 0);
      const cashierSales = salesToday.reduce((agg, r) => { if(!agg[r.cashierName]) agg[r.cashierName] = 0; agg[r.cashierName] += r.total; return agg; }, {});
      const el = $('report-content');
      el.innerHTML = `
        <div style='text-align:center;margin-bottom:8px'><div class='logo' style='width:72px;height:72px;border-radius:999px;margin:0 auto;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:900'>SB</div><div style='font-weight:900;font-size:18px;margin-top:8px'>${escapeHtml(State.settings.businessName||'SmartBizz')}</div><div class='small'>${escapeHtml(State.settings.address||'')}</div><div class='small'>VAT: ${escapeHtml(State.settings.vat||'')}</div></div>
        <div style='text-align:center;font-weight:bold'>Z-Report for ${today.toLocaleDateString()}</div>
        <div style='margin-top:12px;display:flex;justify-content:space-between'><span>Gross Sales:</span><span>${formatCurrency(totalSales)}</span></div>
        <div style='display:flex;justify-content:space-between'><span>Refunds:</span><span style='color:red'>${formatCurrency(totalRefunds)}</span></div>
        <hr>
        <div style='display:flex;justify-content:space-between;font-weight:bold'><span>Net Sales:</span><span>${formatCurrency(totalSales + totalRefunds)}</span></div>
        <h5 style='margin-top:12px;margin-bottom:0'>Sales by Cashier:</h5>
        <div style='margin-top:4px'>
          ${Object.entries(cashierSales).map(([cashier, sales]) => `<div style='display:flex;justify-content:space-between;font-size:12px;padding:2px 0'><span>${cashier}:</span><span>${formatCurrency(sales)}</span></div>`).join('')}
        </div>
        <div style='text-align:center;margin-top:12px;font-size:12px' class='small'>--- End of Report ---</div>
        <div style='display:flex;gap:8px;justify-content:center;margin-top:10px'>
          <button class='btn' id='printReport'>Print</button>
        </div>
      `;
      $('printable-content').classList.remove('hidden');
      $('receipt-content').style.display = 'none';
      $('report-content').style.display = '';
      showReceiptWidthSelector(false); // Reports are full-width, no selector needed
      document.getElementById('printReport').onclick = ()=>{ window.print(); };
    }

    // --- Settings ---
    function renderSettings(){
      const el = $('settings-page');
      const s = State.settings;
      el.innerHTML = `<h3>Settings</h3>
        <div style='display:grid;gap:8px'>
          <label>Business Name</label><input id='set-businessName' value='${escapeHtml(s.businessName||'')}' />
          <label>Address</label><input id='set-address' value='${escapeHtml(s.address||'')}' />
          <label>VAT/Tax No.</label><input id='set-vat' value='${escapeHtml(s.vat||'')}' />
          <label>Currency</label><input id='set-currency' value='${escapeHtml(s.currency||'')}' />
          <label>Tax Percent (%)</label><input id='set-taxPercent' type='number' value='${s.taxPercent||0}' />
          <button class='btn' id='set-save'>Save Settings</button>
        </div>`;
      $('set-save').onclick = ()=>{
        State.settings = {
          businessName: $('set-businessName').value.trim(),
          address: $('set-address').value.trim(),
          vat: $('set-vat').value.trim(),
          currency: $('set-currency').value.trim(),
          taxPercent: Number($('set-taxPercent').value||0)
        };
        saveState();
        alert('Settings saved!');
        renderAll();
      };
    }

    // --- CSV Functions (import/export) ---
    function exportCSV(type){
      let data;
      let headers;
      if(type === 'products'){
        data = State.products;
        headers = ['id','sku','name','category','price','stock'];
      } else if(type === 'customers'){
        data = State.customers;
        headers = ['id','name','contact'];
      } else {
        alert('Invalid export type'); return;
      }
      const csv = [headers.join(',')].concat(data.map(row => headers.map(h => `"${(row[h]||'').toString().replace(/"/g, '""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${type}_export_${new Date().toISOString()}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    function importProductsCSV(){
      const modal = showModal('Import Products', `
        <p>Upload a CSV file with columns: sku,name,category,price,stock.</p>
        <input type="file" id="import-file" accept=".csv" />
        <div style='display:flex;gap:8px;justify-content:flex-end;margin-top:12px'>
          <button class='btn' id='modal-save'>Import</button>
          <button class='btn secondary' id='modal-cancel'>Cancel</button>
        </div>
      `, (modal) => {
        const file = modal.querySelector('#import-file').files[0];
        if(!file){ alert('Please select a file'); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const lines = text.split('\n').filter(l => l.trim() !== '');
          const headers = lines[0].split(',').map(h=>h.trim());
          const newProducts = [];
          for(let i = 1; i < lines.length; i++){
            const values = lines[i].split(',').map(v=>v.trim());
            const p = {};
            for(let j = 0; j < headers.length; j++){ p[headers[j]] = values[j]; }
            if(p.sku && p.name && p.price){ newProducts.push({id:pid('p'), sku:p.sku, name:p.name, category:p.category, price:Number(p.price), stock:Number(p.stock||0)}); }
          }
          State.products = [...State.products, ...newProducts];
          saveState();
          modal.remove();
          renderAll();
          alert(`Imported ${newProducts.length} products.`);
        };
        reader.readAsText(file);
      });
    }
  </script>
</body>
</html>
